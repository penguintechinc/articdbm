---
# ServiceAccount for Flink Kubernetes Operator
apiVersion: v1
kind: ServiceAccount
metadata:
  name: flink-kubernetes-operator
  namespace: articdbm-bigdata
  labels:
    app.kubernetes.io/name: flink-kubernetes-operator
    app.kubernetes.io/component: operator

---
# ClusterRole for Flink Kubernetes Operator
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: flink-kubernetes-operator
  labels:
    app.kubernetes.io/name: flink-kubernetes-operator
    app.kubernetes.io/component: operator
rules:
  - apiGroups: [""]
    resources: ["pods", "pods/log", "pods/exec"]
    verbs: ["create", "delete", "deleteCollection", "get", "list", "patch", "update", "watch"]
  - apiGroups: [""]
    resources: ["services"]
    verbs: ["create", "delete", "deleteCollection", "get", "list", "patch", "update", "watch"]
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["create", "delete", "deleteCollection", "get", "list", "patch", "update", "watch"]
  - apiGroups: [""]
    resources: ["persistentvolumeclaims"]
    verbs: ["create", "delete", "deleteCollection", "get", "list", "patch", "update", "watch"]
  - apiGroups: ["flink.apache.org"]
    resources: ["flinkdeployments", "flinkdeployments/status", "flinksessionjobs", "flinksessionjobs/status"]
    verbs: ["create", "delete", "deleteCollection", "get", "list", "patch", "update", "watch"]
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "delete", "deleteCollection", "get", "list", "patch", "update", "watch"]

---
# ClusterRoleBinding for Flink Kubernetes Operator
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: flink-kubernetes-operator
  labels:
    app.kubernetes.io/name: flink-kubernetes-operator
    app.kubernetes.io/component: operator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: flink-kubernetes-operator
subjects:
  - kind: ServiceAccount
    name: flink-kubernetes-operator
    namespace: articdbm-bigdata

---
# CRD for FlinkDeployment
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: flinkdeployments.flink.apache.org
  labels:
    app.kubernetes.io/name: flink-kubernetes-operator
spec:
  group: flink.apache.org
  names:
    kind: FlinkDeployment
    plural: flinkdeployments
    singular: flinkdeployment
  scope: Namespaced
  versions:
    - name: v1beta1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              type: object
              required:
                - flinkVersion
              properties:
                flinkVersion:
                  type: string
                mode:
                  type: string
                  enum: ["Native", "Standalone"]
                image:
                  type: object
                  properties:
                    repository:
                      type: string
                    tag:
                      type: string
                jobManager:
                  type: object
                  properties:
                    replicas:
                      type: integer
                    resource:
                      type: object
                taskManager:
                  type: object
                  properties:
                    replicas:
                      type: integer
                    resource:
                      type: object
                job:
                  type: object
                  properties:
                    jarURI:
                      type: string
                    entryClass:
                      type: string
                    args:
                      type: array
                      items:
                        type: string
                    parallelism:
                      type: integer
                restartNonce:
                  type: integer
            status:
              type: object
              properties:
                phase:
                  type: string
                jobStatus:
                  type: object

---
# CRD for FlinkSessionJob
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: flinksessionjobs.flink.apache.org
  labels:
    app.kubernetes.io/name: flink-kubernetes-operator
spec:
  group: flink.apache.org
  names:
    kind: FlinkSessionJob
    plural: flinksessionjobs
    singular: flinksessionjob
  scope: Namespaced
  versions:
    - name: v1beta1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              type: object
              required:
                - deploymentName
                - job
              properties:
                deploymentName:
                  type: string
                job:
                  type: object
                  properties:
                    jarURI:
                      type: string
                    entryClass:
                      type: string
                    parallelism:
                      type: integer

---
# ConfigMap for Flink Operator Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: flink-operator-config
  namespace: articdbm-bigdata
  labels:
    app.kubernetes.io/name: flink-kubernetes-operator
data:
  flink-conf.yaml: |
    jobmanager.rpc.address: localhost
    jobmanager.rpc.port: 6123
    taskmanager.rpc.port: 6122
    taskmanager.memory.process.size: 1728m
    jobmanager.memory.process.size: 1600m

---
# Deployment for Flink Kubernetes Operator
apiVersion: apps/v1
kind: Deployment
metadata:
  name: flink-kubernetes-operator
  namespace: articdbm-bigdata
  labels:
    app.kubernetes.io/name: flink-kubernetes-operator
    app.kubernetes.io/component: operator
spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app.kubernetes.io/name: flink-kubernetes-operator
      app.kubernetes.io/component: operator
  template:
    metadata:
      labels:
        app.kubernetes.io/name: flink-kubernetes-operator
        app.kubernetes.io/component: operator
        app.kubernetes.io/version: 1.7.1
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9249"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: flink-kubernetes-operator
      securityContext:
        runAsNonRoot: true
        runAsUser: 9999
        fsGroup: 9999
      containers:
        - name: flink-operator
          image: ghcr.io/apache/flink-kubernetes-operator:1.7.1
          imagePullPolicy: IfNotPresent
          ports:
            - name: metrics
              containerPort: 9249
              protocol: TCP
          env:
            - name: OPERATOR_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: OPERATOR_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: FLINK_CONF_DIR
              value: /etc/flink
            - name: FLINK_HOME
              value: /opt/flink
            - name: ENABLE_WEBHOOK
              value: "true"
            - name: WEBHOOK_PORT
              value: "9443"
          resources:
            requests:
              cpu: 100m
              memory: 512Mi
            limits:
              cpu: 500m
              memory: 1Gi
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 20
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          volumeMounts:
            - name: flink-config
              mountPath: /etc/flink
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: flink-config
          configMap:
            name: flink-operator-config
        - name: tmp
          emptyDir: {}
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - flink-kubernetes-operator
                topologyKey: kubernetes.io/hostname
      tolerations:
        - key: "node.kubernetes.io/not-ready"
          operator: "Exists"
          effect: "NoExecute"
          tolerationSeconds: 300
        - key: "node.kubernetes.io/unreachable"
          operator: "Exists"
          effect: "NoExecute"
          tolerationSeconds: 300
