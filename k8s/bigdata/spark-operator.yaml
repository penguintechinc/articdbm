---
# ServiceAccount for Spark Operator
apiVersion: v1
kind: ServiceAccount
metadata:
  name: spark-operator
  namespace: articdbm-bigdata
  labels:
    app.kubernetes.io/name: spark-operator
    app.kubernetes.io/component: operator

---
# ClusterRole for Spark Operator
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: spark-operator
  labels:
    app.kubernetes.io/name: spark-operator
    app.kubernetes.io/component: operator
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["create", "delete", "deleteCollection", "get", "list", "patch", "update", "watch"]
  - apiGroups: [""]
    resources: ["pods/log"]
    verbs: ["get"]
  - apiGroups: [""]
    resources: ["services"]
    verbs: ["create", "delete", "get", "list", "patch", "update", "watch"]
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["create", "delete", "get", "list", "patch", "update", "watch"]
  - apiGroups: [""]
    resources: ["persistentvolumeclaims"]
    verbs: ["create", "delete", "get", "list", "patch", "update", "watch"]
  - apiGroups: ["spark.apache.org"]
    resources: ["sparkapplications", "sparkapplications/status", "scheduledsparkapplications", "scheduledsparkapplications/status"]
    verbs: ["create", "delete", "deleteCollection", "get", "list", "patch", "update", "watch"]
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "delete", "get", "list", "patch", "update", "watch"]
  - apiGroups: ["apiextensions.k8s.io"]
    resources: ["customresourcedefinitions"]
    verbs: ["create", "get", "update"]
  - apiGroups: ["batch"]
    resources: ["jobs"]
    verbs: ["create", "delete", "get", "list", "patch", "update", "watch"]

---
# ClusterRoleBinding for Spark Operator
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: spark-operator
  labels:
    app.kubernetes.io/name: spark-operator
    app.kubernetes.io/component: operator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: spark-operator
subjects:
  - kind: ServiceAccount
    name: spark-operator
    namespace: articdbm-bigdata

---
# CRD for SparkApplication
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: sparkapplications.spark.apache.org
  labels:
    app.kubernetes.io/name: spark-operator
spec:
  group: spark.apache.org
  names:
    kind: SparkApplication
    plural: sparkapplications
    singular: sparkapplication
  scope: Namespaced
  versions:
    - name: v1beta2
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              type: object
              required:
                - sparkVersion
                - type
                - mainApplicationFile
              properties:
                sparkVersion:
                  type: string
                type:
                  type: string
                  enum: ["Scala", "Java", "Python", "R"]
                mainApplicationFile:
                  type: string
                mainClass:
                  type: string
                arguments:
                  type: array
                  items:
                    type: string
                driver:
                  type: object
                executor:
                  type: object
                deps:
                  type: object
                restartPolicy:
                  type: object
                  properties:
                    type:
                      type: string
                    onFailureRetries:
                      type: integer
                    onFailureRetryInterval:
                      type: integer
                    onSubmissionFailureRetries:
                      type: integer
            status:
              type: object
              properties:
                appState:
                  type: object
                executorState:
                  type: object
                appId:
                  type: string
                submissionID:
                  type: string

---
# CRD for ScheduledSparkApplication
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: scheduledsparkapplications.spark.apache.org
  labels:
    app.kubernetes.io/name: spark-operator
spec:
  group: spark.apache.org
  names:
    kind: ScheduledSparkApplication
    plural: scheduledsparkapplications
    singular: scheduledsparkapplication
  scope: Namespaced
  versions:
    - name: v1beta1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              type: object
              required:
                - schedule
                - template
              properties:
                schedule:
                  type: string
                timezone:
                  type: string
                template:
                  type: object
                concurrencyPolicy:
                  type: string
                successfulJobsHistoryLimit:
                  type: integer
                failedJobsHistoryLimit:
                  type: integer

---
# Deployment for Spark Operator
apiVersion: apps/v1
kind: Deployment
metadata:
  name: spark-operator
  namespace: articdbm-bigdata
  labels:
    app.kubernetes.io/name: spark-operator
    app.kubernetes.io/component: operator
spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app.kubernetes.io/name: spark-operator
      app.kubernetes.io/component: operator
  template:
    metadata:
      labels:
        app.kubernetes.io/name: spark-operator
        app.kubernetes.io/component: operator
        app.kubernetes.io/version: v1.3.10
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: spark-operator
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      containers:
        - name: spark-operator
          image: gcr.io/spark-operator/spark-operator:v1.3.10
          imagePullPolicy: IfNotPresent
          ports:
            - name: metrics
              containerPort: 8080
              protocol: TCP
          env:
            - name: SPARK_OPERATOR_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: LEADER_ELECTION_ENABLED
              value: "true"
            - name: LEADER_ELECTION_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 20
          readinessProbe:
            httpGet:
              path: /readyz
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - spark-operator
                topologyKey: kubernetes.io/hostname
      tolerations:
        - key: "node.kubernetes.io/not-ready"
          operator: "Exists"
          effect: "NoExecute"
          tolerationSeconds: 300
        - key: "node.kubernetes.io/unreachable"
          operator: "Exists"
          effect: "NoExecute"
          tolerationSeconds: 300
